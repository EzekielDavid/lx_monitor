<!Doctype html>


<body onload="init()">





    </body>





    </html>




<!doctype html>
  <html class="sidebar-light sidebar-left-big-icons fixed sidebar-left-with-menu">
  <head>

    <!-- Basic -->
    <meta charset="UTF-8">

    <title>Lite Xpress  | Monitoring 1.0</title>
    <meta name="keywords" content="HTML5 Admin Template" />
    <meta name="description" content="Porto Admin - Responsive HTML5 Template">
    <meta name="author" content="okler.net">

    <!-- Mobile Metas -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

    <!-- Web Fonts  -->
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600,700,800|Shadows+Into+Light" rel="stylesheet" type="text/css">

    <!-- Vendor CSS -->
    <link rel="stylesheet" href="vendor/bootstrap/css/bootstrap.css" />
    <link rel="stylesheet" href="vendor/animate/animate.css">

    <link rel="stylesheet" href="vendor/font-awesome/css/fontawesome-all.min.css" />
    <link rel="stylesheet" href="vendor/magnific-popup/magnific-popup.css" />
    <link rel="stylesheet" href="vendor/bootstrap-datepicker/css/bootstrap-datepicker3.css" />

    <!-- Specific Page Vendor CSS -->

    <link rel="stylesheet" href="vendor/select2/css/select2.css" />
    <link rel="stylesheet" href="vendor/select2-bootstrap-theme/select2-bootstrap.min.css" />

    <!-- Theme CSS -->
    <link rel="stylesheet" href="css/theme.css" />

    <!-- Skin CSS -->
    <link rel="stylesheet" href="css/skins/default.css" />

    <!-- Theme Custom CSS -->
    <link rel="stylesheet" href="css/custom.css">

    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.4/dist/leaflet.css" integrity="sha512-puBpdR0798OZvTTbP4A8Ix/l+A4dHDD0DGqYW6RQ+9jxkRFclaxxQb/SJAWZfWAkuyeQUytO7+7N4QKrDh+drA==" crossorigin="" />
 
    <style>
      #map {
        height: 800px;
        width: 100%;
      }

      .accordion {
        background-color: #eee;
        color: #444;
        cursor: pointer;
        padding: 18px;
        width: 100%;
        text-align: left;
        border: none;
        outline: none;
        transition: 0.4s;
      }

      .active, .accordion:hover {
        background-color: #ccc;
      }

      .panel {
        padding: 0 18px;
        background-color: white;
        display: none;
        overflow: hidden;
        } #container {
          width: 100%;
          height: 100%;
          margin: 0;
          padding: 0;
        }
    </style>

    <!-- Head Libs -->
    <script src="vendor/modernizr/modernizr.js"></script>
    <script src="https://unpkg.com/leaflet@1.3.4/dist/leaflet.js" integrity="sha512-nMMmRyTVoLYqjP9hrbed9S+FzjZHW5gY1TWCHA5ckwXZBadntCNs8kEqAWdrb9O7rxbCaA4lKTIWjDXZxflOcA==" crossorigin=""></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.4.0/Chart.min.js"></script>

  </head>
  <body onload="init()">
    <section class="body">

      <!-- start: header -->
      <header class="header">
        <div class="logo-container">
          <a href="../2.1.1" class="logo">
            <img src="img/lx_logo.png" width="75" height="35" alt="Porto Admin" />
          </a>
          <div class="d-md-none toggle-sidebar-left" data-toggle-class="sidebar-left-opened" data-target="html" data-fire-event="sidebar-left-opened">
            <i class="fas fa-bars" aria-label="Toggle sidebar"></i>
          </div>
        </div>
      
        <!-- start: search & user box -->
        <!-- <div class="header-right">
          <div id="userbox" class="userbox">
            <a href="#" data-toggle="dropdown">
              <figure class="profile-picture">
                <img src="img/!logged-user.jpg" alt="Joseph Doe" class="rounded-circle" data-lock-picture="img/!logged-user.jpg" />
              </figure>
              <div class="profile-info" data-lock-name="User" data-lock-email="user@mail.com">
                <span class="name">User</span>
 
              </div>
      
              <i class="fa custom-caret"></i>
            </a>
      
            <div class="dropdown-menu">
              <ul class="list-unstyled mb-2">
                <li class="divider"></li>
                <li>
                  <a role="menuitem" tabindex="-1" href="pages-user-profile.html"><i class="fas fa-user"></i> My Profile</a>
                </li>
                <li>
                  <a role="menuitem" tabindex="-1" href="#" data-lock-screen="true"><i class="fas fa-lock"></i> Lock Screen</a>
                </li>
                <li>
                  <a role="menuitem" tabindex="-1" href="pages-signin.html"><i class="fas fa-power-off"></i> Logout</a>
                </li>
              </ul>
            </div>
          </div>
        </div> -->
        <!-- end: search & user box -->
      </header>
      <!-- end: header -->

      <div class="inner-wrapper">
        <!-- start: sidebar -->
        <aside id="sidebar-left" class="sidebar-left">
        
            <div class="sidebar-header">
                <div class="sidebar-title">
                    Navigation
                </div>
                <div class="sidebar-toggle d-none d-md-block" data-toggle-class="sidebar-left-collapsed" data-target="html" data-fire-event="sidebar-left-toggle">
                    <i class="fas fa-bars" aria-label="Toggle sidebar"></i>
                </div>
            </div>
        
            <div class="nano">
                <div class="nano-content">
                    <nav id="menu" class="nav-main" role="navigation">
                    
                        <ul class="nav nav-main">
                           <li class="nav-parent nav-expanded">
                                <a class="nav-link" href="lx_dashboard.html">
                                    <i class="fas fa-home" aria-hidden="true"></i>
                                    <span>Dashboard</span>
                                </a>                        
                            </li>
							 <li class="nav-active">
                            
                                <a class="nav-link" href="lx_monitor.html">
                                    <i class="fas fa-map-marker-alt" aria-hidden="true"></i>
                                    <span>Maps</span>
                                </a>
                            </li>
        
                        </ul>
                    </nav>
        
                    <hr class="separator" />
        
                    <div class="sidebar-widget widget-tasks">
                        <div class="widget-header">
                            <h6>Projects</h6>
                            <div class="widget-toggle">+</div>
                        </div>
                        <div class="widget-content">
                            <ul class="list-unstyled m-0">
                                <li><a href="#">Porto HTML5 Template</a></li>
                                <li><a href="#">Tucson Template</a></li>
                                <li><a href="#">Porto Admin</a></li>
                            </ul>
                        </div>
                    </div>
        
                    <hr class="separator" />
        
                    <div class="sidebar-widget widget-stats">
                        <div class="widget-header">
                            <h6>Company Stats</h6>
                            <div class="widget-toggle">+</div>
                        </div>
                        <div class="widget-content">
                            <ul>
                                <li>
                                    <span class="stats-title">Stat 1</span>
                                    <span class="stats-complete">85%</span>
                                    <div class="progress">
                                        <div class="progress-bar progress-bar-primary progress-without-number" role="progressbar" aria-valuenow="85" aria-valuemin="0" aria-valuemax="100" style="width: 85%;">
                                            <span class="sr-only">85% Complete</span>
                                        </div>
                                    </div>
                                </li>
                                <li>
                                    <span class="stats-title">Stat 2</span>
                                    <span class="stats-complete">70%</span>
                                    <div class="progress">
                                        <div class="progress-bar progress-bar-primary progress-without-number" role="progressbar" aria-valuenow="70" aria-valuemin="0" aria-valuemax="100" style="width: 70%;">
                                            <span class="sr-only">70% Complete</span>
                                        </div>
                                    </div>
                                </li>
                                <li>
                                    <span class="stats-title">Stat 3</span>
                                    <span class="stats-complete">2%</span>
                                    <div class="progress">
                                        <div class="progress-bar progress-bar-primary progress-without-number" role="progressbar" aria-valuenow="2" aria-valuemin="0" aria-valuemax="100" style="width: 2%;">
                                            <span class="sr-only">2% Complete</span>
                                        </div>
                                    </div>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
        
                <script>
                    // Maintain Scroll Position
                    if (typeof localStorage !== 'undefined') {
                        if (localStorage.getItem('sidebar-left-position') !== null) {
                            var initialPosition = localStorage.getItem('sidebar-left-position'),
                                sidebarLeft = document.querySelector('#sidebar-left .nano-content');
                            
                            sidebarLeft.scrollTop = initialPosition;
                        }
                    }
                </script>
                
        
            </div>
        
        </aside>
        <!-- end: sidebar -->


        <section role="main" class="content-body">
                    <header class="page-header">
            <h2>LX Real Time Monitoring</h2>
          
            <div class="right-wrapper text-right">
              <ol class="breadcrumbs">
                <li>
                  <a href="lx_dashboard.html">
                    <i class="fas fa-home"></i>
                  </a>
                </li>
                <li><span>Maps</span></li>
                <li><span>Monitor</span></li>
              </ol>
          
              <a class="sidebar-right-toggle" data-open="sidebar-right"><i class="fas fa-chevron-left"></i></a>
            </div>
          </header>

          <!-- start: page -->
          <section class="content-with-menu" data-theme-gmap-builder>
            <div class="content-with-menu-container">

              <div class="inner-menu-toggle">
                <a href="#" class="inner-menu-expand" data-open="inner-menu">
                  Show Options <i class="fas fa-chevron-right"></i>
                </a>
              </div>

              <menu id="content-menu" class="inner-menu" role="menu">
                <div class="nano">
                  <div class="nano-content">

                    <div class="inner-menu-toggle-inside">
                      <a href="#" class="inner-menu-collapse">
                        <i class="fas fa-chevron-up d-inline-block d-md-none"></i><i class="fas fa-chevron-left d-none d-md-inline-block"></i> Hide Options
                      </a>
                      <a href="#" class="inner-menu-expand" data-open="inner-menu">
                        Show Options <i class="fas fa-chevron-down"></i>
                      </a>
                    </div>

                    <div class="inner-menu-content">

                      <p class="title">Search Input</p>

                      <div class="form-group">
                        <div class="row">

                          <div class="col-sm-12">
                            <select data-plugin-selectTwo class="form-control populate user_list" name="users">
                              <option value="-1"> Search User </option>
                            </select>
                          </div>
                          <label class="col-sm-12 control-label">Date</label>
                          <div class="col-sm-12">
                            <div class="input-group">
                            <span class="input-group-prepend">
                              <span class="input-group-text">
                                <i class="fas fa-calendar-alt"></i>
                              </span>
                            </span>
                            <input id="date" type="date"  class="form-control">
                          </div>
                          </div>


                          <label class="col-sm-12 control-label" for="longitude">End Date</label>
                          <div class="col-sm-12">
                            <div class="input-group">
                            <span class="input-group-prepend">
                              <span class="input-group-text">
                                <i class="fas fa-calendar-alt"></i>
                              </span>
                            </span>
                            <input id="date_end" type="date"  class="form-control">
                          </div>
                          </div>
                        </div>
                      </div>

                      <hr class="separator" />

                      <div class="form-group">
                        <ul id="MarkersList" class="list-markers list-unstyled mb-3 hidden">
                        </ul>

                        <div class="row">
                          <div class="col-sm-6">
                            <button class="btn btn-primary btn-block mb-3 float-right" type="button" onclick="search()">Search</button>
                          </div>
                        </div>
                      </div>

                    </div>
                  </div>
                </div>
              </menu>
              <div class="inner-body">
               <button class="accordion">User Actvities</button>

  <canvas id="status_graph" width="400" height="400"></canvas>


  <div class="panel">
  </div>
  <br>
  <center><h2><p id = "search_result">Today's Realtime Activities</p></h2></center>
  <div id="map"></div>
              </div>
          </section>

          <div id="MarkerModal" class="marker-modal modal fade" tabindex="-1" role="dialog" aria-labelledby="MarkerModal" aria-hidden="true">
            <div class="modal-dialog">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title">Choose Marker Location</h5>
                  <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                  </button>
                </div>
                <form>
                  <div class="modal-body">
                    <div class="form-group">
                      <label for="MarkerLocation">Address or Latitude and Longitude</label>
                      <input id="MarkerLocation" name="location" type="text" class="form-control">
                    </div>
                    <div class="form-group">
                      <label for="MarkerTitle">Title</label>
                      <input id="MarkerTitle" name="title" type="text" class="form-control">
                    </div>
                    <div class="form-group">
                      <label for="MarkerDescription">Description</label>
                      <textarea id="MarkerDescription" name="description" type="text" rows="3" class="form-control"></textarea>
                    </div>
                  </div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                    <button id="MarkerSave" type="submit" class="btn btn-primary">Save</button>
                  </div>
                </form>
              </div>
            </div>
          </div>

          <div id="ModalPreview" class="preview-modal modal fade" tabindex="-1" role="dialog" aria-labelledby="ModalPreview" aria-hidden="true">
            <div class="modal-dialog modal-lg">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title">Map Preview</h5>
                  <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                  </button>
                </div>
                <div class="modal-body">
                  <iframe src="" style="border: none; width: 100%; height: 70vh;"></iframe>
                </div>
              </div>
            </div>
          </div>

          <div id="ModalGetCode" class="preview-modal modal fade" tabindex="-1" role="dialog" aria-labelledby="ModalGetCode" aria-hidden="true">
            <div class="modal-dialog modal-lg">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title">Generated Code</h5>
                  <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                  </button>
                </div>
                <div class="modal-body">
                  <pre></pre>
                </div>
              </div>
            </div>
          </div>

          <!-- end: page -->
        </section>
      </div>


    </section>

    <!-- Vendor -->
    <script src="vendor/jquery/jquery.js"></script>
    <script src="vendor/jquery-browser-mobile/jquery.browser.mobile.js"></script>
    <script src="vendor/popper/umd/popper.min.js"></script>
    <script src="vendor/bootstrap/js/bootstrap.js"></script>
    <script src="vendor/bootstrap-datepicker/js/bootstrap-datepicker.js"></script>
    <script src="vendor/common/common.js"></script>
    <script src="vendor/nanoscroller/nanoscroller.js"></script>
    <script src="vendor/magnific-popup/jquery.magnific-popup.js"></script>
    <script src="vendor/jquery-placeholder/jquery-placeholder.js"></script>
    
    <!-- Specific Page Vendor -->

    <script src="vendor/select2/js/select2.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY"></script>
    <script src="vendor/snazzy-themes/snazzy.themes.js"></script>
    <!-- Theme Base, Components and Settings -->
    <script src="js/theme.js"></script>
    
    <!-- Theme Custom -->
    <script src="js/custom.js"></script>
    
    <!-- Theme Initialization Files -->
    <script src="js/theme.init.js"></script>

      <!-- Examples -->
    <script src="js/examples/examples.map.builder.js"></script>

    <script>
    var acc = document.getElementsByClassName("accordion");
    var i;

    for (i = 0; i < acc.length; i++) {
      acc[i].addEventListener("click", function() {
        this.classList.toggle("active");
        var panel = this.nextElementSibling;
        if (panel.style.display === "block") {
          panel.style.display = "none";
        } else {
          panel.style.display = "block";
        }
      });

    }
    </script>

    <script>
          var map;
          var _batch_location;
          var _info;
          var markers;
          var status_graph;
          setInterval(request_next_batch_location, 5000);
          setInterval(update_users_status, 3000);
      
      
      
          function load_users()
          {
            $.ajax({
              url: 'http://210.14.16.69:8080/api/mobile.php',
              type: 'post',
              data: {
                action: 'get_users'
              },
              success: function(data) {
                var users = JSON.parse(data);
                users.forEach(function(user) {
                  var new_option = document.createElement("OPTION");
                  new_option.setAttribute("value", user['id']);
                  new_option.text = user['name'];
                  $('.user_list').append(new_option);
                });
                $(document).ready(function() {
                  $('.user_list').select2();
                });

              }
            });
          }
          function update_users_status()
          {
            $.ajax({
              url: 'http://210.14.16.69:8080/api/mobile.php',
              type: 'post',
              data: {
                action: 'get_user_status'
              },
              success: function(data) {
                  var status = JSON.parse(data);
                  status_graph.data.datasets[0].data =
                  [status['online_users'], status['intransit_users'],status['standby_users']];
                  status_graph.update();
              }
            });
          }
          function load_users_status()
          {
            $.ajax({
              url: 'http://210.14.16.69:8080/api/mobile.php',
              type: 'post',
              data: {
                action: 'get_user_status'
              },
              success: function(data) {
                var status = JSON.parse(data);
                var ctx = document.getElementById("status_graph");
                ctx.height = 50;
                status_graph = new Chart(ctx, {
                  type: 'bar',
                  data: {
                    labels: ["Online", "In-transit", "Standby"],
                    datasets: [{
                      label: 'Current activities of users',
                      data: [status['online_users'], status['intransit_users'], status['standby_users']],
                      backgroundColor: [
                      'rgba(255, 192, 0, 1)',
                      'rgba(255, 192, 0, 1)',
                      'rgba(255, 192, 0, 1)'
                      ],
                      borderWidth: 1
                    }]
                  },
                  options: {
                    scales: {
                      yAxes: [{
                       ticks: {
                        min: 1,
                        max: parseInt(status['user_count'])
                      }
                    }]
                  }
                }
              });
              }
            });
          }
          function search() {
            localStorage.setItem("date", document.getElementById("date").valueAsDate);
            localStorage.setItem("date_end", document.getElementById("date_end").valueAsDate);
            var data = $('.user_list').select2('data');
            var id = data[0].id;
            var text = data[0].text;
            if ( id != '-1' ) {
              localStorage.setItem("searched_user_id", id);
              localStorage.setItem("searched_user_text", text);
            }
            localStorage.setItem("searched", true);
            window.location.reload(true);
          }

          function set_date_today() {
            $.ajax({
              url: 'http://210.14.16.69:8080/api/mobile.php',
              type: 'post',
              data: {
                action: 'get_time',
                format: 'Y-m-d'
              },
              success: function(data) {
                data += 'T00:00:00.000Z';
                var latest_date = new Date(data);
                document.getElementById("date").valueAsDate = latest_date;
                localStorage.setItem("date", latest_date);

                document.getElementById("date_end").valueAsDate = latest_date;
                localStorage.setItem("date_end", latest_date);
              }
            });
          }

          function init_date() {
            if (localStorage.getItem("date") == null) {
              set_date_today();
            } else {
              document.getElementById("date").valueAsDate = new Date(localStorage.getItem("date"));
              document.getElementById("date_end").valueAsDate = new Date(localStorage.getItem("date_end"));
            }
          }


          function init() {
            load_users();
            load_users_status();
            update_users_status();
            init_date();
            markers = new Map();
            map = L.map('map').setView([14.5844845, 121.0625503], 15);
            L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw', {
              maxZoom: 25,
              id: 'mapbox.streets'
            }).addTo(map);
            request_next_batch_location();
          }

          function move_marker() {

            _batch_location.forEach(function(batch_location) {
              var marker = markers.get(batch_location['CourierDriverID']);
              if (marker != undefined) {

                var ll = marker.getLatLng();
                var from = new L.LatLng(ll.lat, ll.lng);
                var to = new L.LatLng(parseFloat(batch_location['latitude']), parseFloat(batch_location['longitude']));


                var new_line = new L.Polyline([from, to], {
                  color: 'red',
                  weight: 3,
                  opacity: 1.0,
                  smoothFactor: 1
                });
                new_line.addTo(map);
                marker.setLatLng(to);
              } else {
                console.log("else");


                var new_marker = new L.marker(new L.LatLng(parseFloat(batch_location['latitude']), parseFloat(batch_location['longitude'])));
                _info.forEach(function(info) {
                  if (info["CourierDriverID"] == batch_location['CourierDriverID'])
                  {
                   new_marker.bindPopup("<b>" + info["name"] + "</b><br>" +
                    info["branch"]);
                 }
               });

                new_marker.addTo(map);

                new_marker.on('mouseover', function(e) {
                  this.openPopup();
                });
                new_marker.on('mouseout', function(e){
                  this.closePopup();
                });

                markers.set(batch_location['CourierDriverID'], new_marker);


              }
            });

          }

          function map_to_json(map) {
            var json_obj = {};
            map.forEach(function(val, key) {
              json_obj[key] = val;
            });
            return JSON.stringify(json_obj);
          }


          function get_distinct_latest_locations() {

            var batch_location_temp = _batch_location;

            var map_struct = new Map();

            var length = Object.keys(batch_location_temp).length;

            for (var a = 0; a < length; a++) {
              map_struct.set(batch_location_temp[a]['CourierDriverID'], batch_location_temp[a]['ID']);
            }
            return map_to_json(map_struct);

          }

          function request_next_batch_location() {

            var is_searched = localStorage.getItem("searched");
            var search_result = document.getElementById('search_result');

            var searched_date = new Date(document.getElementById("date").valueAsDate);
            searched_date = searched_date.getFullYear() + "-" + (searched_date.getMonth() + 1) + "-" + (searched_date.getDate());


            var searched_date_end = new Date(document.getElementById("date_end").valueAsDate);
            searched_date_end = searched_date_end.getFullYear() + "-" + (searched_date_end.getMonth() + 1) + "-" + (searched_date_end.getDate());

            if (_batch_location != null) {
              $.ajax({
                url: 'http://210.14.16.69:8080/api/mobile.php',
                type: 'post',
                data: {
                  action: 'location',
                  _batch_location: get_distinct_latest_locations(),
                  date: searched_date,
                  type: 'get'
                },
                success: function(data) {
                  var json_temp = JSON.parse(data);
                  if (Object.keys(json_temp).length > 0) {
                    console.log("greater than 0 if");
                    _batch_location = json_temp['location'];
                    _info = json_temp['info'];
                    move_marker();

                  } else {
                    console.log("less than 0 if");
                  }
                }
              });
            } else {

              //default data
              var data = {
                action: 'location',
                date: searched_date,
                type: 'get',
                search_type: 'dateonly'
              }

              var id = localStorage.getItem("searched_user_id");
              var text = localStorage.getItem("searched_user_text");

              ////for search by name and date
              if ( id != null )
              {
                data.search_type = 'user_and_date';
                data.user_id = id;
              }

              $.ajax({
                url: 'http://210.14.16.69:8080/api/mobile.php',
                type: 'post',
                data: data,
                success: function(data) {
                  var json_temp = JSON.parse(data);
                  _batch_location = json_temp['location'];
                  _info = json_temp['info'];
                  console.log(json_temp);
                  if (Object.keys(_batch_location).length > 0) {
                    if ( is_searched == null ) {
                      search_result.innerHTML = "Today's realtime activities";
                    }
                    else {
                      if ( id == null ) {
                        search_result.innerHTML = "Activities for " + searched_date + " to " + searched_date_end;
                      }
                      else {
                        search_result.innerHTML = "Activities of " + text + " in " + searched_date + " to " + searched_date_end;
                      }
                    }

                    move_marker();
                  } 
                  else {
                    if ( is_searched == null ) {
                      search_result.innerHTML = "No activities as of now";
                    }
                    else {
                      if ( id == null ) {
                        search_result.innerHTML = "No Activities for " + searched_date + " to " + searched_date_end;
                      }
                      else {
                        search_result.innerHTML = "No activities for " + text + " in " + searched_date + " to " + searched_date_end;
                      }
                    }
                  }



                }
              });

            }
            localStorage.clear();
          }
    </script>
  </body>
</html>





